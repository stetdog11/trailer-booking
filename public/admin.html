<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin — All Keys Trailer Repair</title>
    <style>
      body {
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        background: #0b1220;
        color: #e5e7eb;
        padding: 14px;
      }
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
      }
      .card {
        background: #111827;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 14px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
        margin-bottom: 12px;
      }
      h1 {
        margin: 0 0 10px;
        font-size: 18px;
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      input {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: #0b1220;
        color: #e5e7eb;
      }
      button {
        padding: 10px 12px;
        border-radius: 12px;
        border: 0;
        background: #22c55e;
        color: #052e16;
        font-weight: 900;
        cursor: pointer;
      }
      button.secondary {
        background: #334155;
        color: #e5e7eb;
      }
      button.danger {
        background: #ef4444;
        color: #450a0a;
      }
      button.warn {
        background: #f59e0b;
        color: #3b2100;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .muted {
        color: #9ca3af;
        font-size: 13px;
      }
      .nowrap {
        white-space: nowrap;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th,
      td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding: 10px 8px;
        vertical-align: top;
      }
      th {
        text-align: left;
        color: #93c5fd;
        font-size: 12px;
        letter-spacing: 0.04em;
      }

      .pill {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-weight: 900;
        font-size: 12px;
      }
      .p-booked {
        background: #1f2937;
        color: #e5e7eb;
      }
      .p-canceled {
        background: #7f1d1d;
        color: #fee2e2;
      }
      .p-completed {
        background: #064e3b;
        color: #d1fae5;
      }

      @media (max-width: 820px) {
        table,
        thead,
        tbody,
        th,
        td,
        tr {
          display: block;
        }
        thead {
          display: none;
        }
        tr {
          border: 1px solid rgba(255, 255, 255, 0.08);
          border-radius: 14px;
          margin-bottom: 10px;
          padding: 10px;
          background: #0f172a;
        }
        td {
          border: 0;
          padding: 6px 0;
        }
        td::before {
          content: attr(data-label);
          display: block;
          color: #93c5fd;
          font-size: 12px;
          font-weight: 900;
          margin-bottom: 2px;
          letter-spacing: 0.02em;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>Admin — Bookings</h1>
        <div class="row">
          <span class="muted">Filter by date (optional):</span>
          <input id="date" type="date" />
          <button id="load">Load</button>
          <button class="secondary" id="loadAll">Load upcoming</button>
          <span class="muted" id="status"></span>
        </div>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th class="nowrap">Date</th>
              <th class="nowrap">Slot</th>
              <th>Name</th>
              <th class="nowrap">Phone</th>
              <th>Email</th>
              <th>Address</th>
              <th>Notes</th>
              <th class="nowrap">Status</th>
              <th class="nowrap">Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>

    <script>
      const rowsEl = document.getElementById("rows");
      const statusEl = document.getElementById("status");
      const dateEl = document.getElementById("date");

      function esc(s) {
        return String(s || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");
      }

      function statusPill(status) {
        if (status === "canceled")
          return `<span class="pill p-canceled">canceled</span>`;
        if (status === "completed")
          return `<span class="pill p-completed">completed</span>`;
        return `<span class="pill p-booked">booked</span>`;
      }

      async function load(date) {
        statusEl.textContent = "Loading...";
        rowsEl.innerHTML = "";

        const url = date
          ? `/admin/bookings?date=${encodeURIComponent(date)}`
          : `/admin/bookings`;

        const res = await fetch(url);
        if (!res.ok) {
          statusEl.textContent = "Error loading bookings.";
          return;
        }

        const data = await res.json();
        if (!Array.isArray(data)) {
          statusEl.textContent = "Error loading bookings.";
          return;
        }

        statusEl.textContent = `${data.length} booking(s)`;

        data.forEach((b) => {
          const tr = document.createElement("tr");

          const canCancel = b.status === "booked";
          const canComplete = b.status === "booked";

          tr.innerHTML = `
            <td data-label="Date" class="nowrap">${esc(b.date)}</td>
            <td data-label="Slot" class="nowrap">${esc(b.slot)}</td>
            <td data-label="Name">${esc(b.name)}</td>
            <td data-label="Phone" class="nowrap">${esc(b.phone)}</td>
            <td data-label="Email">${esc(b.email)}</td>
            <td data-label="Address">${esc(b.address)}</td>
            <td data-label="Notes">${esc(b.notes)}</td>
            <td data-label="Status" class="nowrap">${statusPill(b.status)}</td>
            <td data-label="Actions" class="nowrap">
              ${
                canComplete
                  ? `<button class="warn" data-complete="${b.id}">Complete</button>`
                  : `<span class="muted">—</span>`
              }
              ${
                canCancel
                  ? ` <button class="danger" data-cancel="${b.id}">Cancel</button>`
                  : ``
              }
            </td>
          `;

          rowsEl.appendChild(tr);
        });

        rowsEl.querySelectorAll("button[data-cancel]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = Number(btn.getAttribute("data-cancel"));
            if (!confirm("Cancel this booking?")) return;

            btn.disabled = true;
            btn.textContent = "Canceling...";

            const r = await fetch("/admin/cancel", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id }),
            });

            if (!r.ok) {
              alert("Cancel failed.");
              btn.disabled = false;
              btn.textContent = "Cancel";
              return;
            }

            await load(dateEl.value || "");
          });
        });

        rowsEl.querySelectorAll("button[data-complete]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = Number(btn.getAttribute("data-complete"));
            if (!confirm("Mark this booking completed?")) return;

            btn.disabled = true;
            btn.textContent = "Saving...";

            const r = await fetch("/admin/complete", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id }),
            });

            if (!r.ok) {
              alert("Complete failed.");
              btn.disabled = false;
              btn.textContent = "Complete";
              return;
            }

            await load(dateEl.value || "");
          });
        });
      }

      document
        .getElementById("load")
        .addEventListener("click", () => load(dateEl.value));
      document.getElementById("loadAll").addEventListener("click", () => {
        dateEl.value = "";
        load("");
      });

      load("");
    </script>
  </body>
</html>
