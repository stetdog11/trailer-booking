<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin — All Keys Trailer Repair</title>
    <style>
      body {
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        background: #0b1220;
        color: #e5e7eb;
        padding: 18px;
      }
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
      }
      .card {
        background: #111827;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 14px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
        margin-bottom: 12px;
      }
      h1 {
        margin: 0 0 10px;
        font-size: 20px;
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      input {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: #0b1220;
        color: #e5e7eb;
      }
      button {
        padding: 10px 12px;
        border-radius: 12px;
        border: 0;
        background: #22c55e;
        color: #052e16;
        font-weight: 800;
        cursor: pointer;
      }
      button.secondary {
        background: #334155;
        color: #e5e7eb;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th,
      td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding: 10px 8px;
        vertical-align: top;
      }
      th {
        text-align: left;
        color: #93c5fd;
        font-size: 12px;
        letter-spacing: 0.04em;
      }
      .pill {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-weight: 800;
        font-size: 12px;
      }
      .booked {
        background: #1f2937;
        color: #e5e7eb;
      }
      .completed {
        background: #16a34a;
        color: #e6ffef;
      }
      .canceled {
        background: #7f1d1d;
        color: #fee2e2;
      }
      .danger {
        background: #ef4444;
        color: #450a0a;
      }
      .muted {
        color: #9ca3af;
      }
      .nowrap {
        white-space: nowrap;
      }
      .btnSmall {
        padding: 6px 8px;
        border-radius: 8px;
        font-weight: 900;
        cursor: pointer;
        border: 0;
      }
      .btnComplete {
        background: #10b981;
        color: #042014;
      }
      .btnCancel {
        background: #ef4444;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>Admin — Bookings</h1>
        <div class="row" style="align-items: center">
          <label class="muted">Filter by date (optional):</label>
          <input id="date" type="date" />
          <button id="load">Load</button>
          <button class="secondary" id="loadAll">Load all</button>
          <button class="secondary" id="refresh" style="margin-left: auto">
            Refresh
          </button>
          <span class="muted" id="status" style="margin-left: 10px"></span>
        </div>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th class="nowrap">Date</th>
              <th class="nowrap">Slot</th>
              <th>Name</th>
              <th class="nowrap">Phone</th>
              <th>Email</th>
              <th>Address</th>
              <th>Notes</th>
              <th class="nowrap">Status</th>
              <th class="nowrap">Action</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>

    <script>
      const rowsEl = document.getElementById("rows");
      const statusEl = document.getElementById("status");
      const dateEl = document.getElementById("date");

      const slotMap = {
        1: "9:00 AM - 12:00 PM",
        2: "12:00 PM - 3:00 PM",
        3: "3:00 PM - 6:00 PM",
      };

      function esc(s) {
        return String(s || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;");
      }

      async function load(date) {
        statusEl.textContent = "Loading...";
        rowsEl.innerHTML = "";
        const url = date
          ? `/admin/bookings?date=${encodeURIComponent(date)}`
          : `/admin/bookings`;
        const res = await fetch(url);
        if (!res.ok) {
          statusEl.textContent = "Error loading bookings.";
          return;
        }
        const data = await res.json();
        statusEl.textContent = `${data.length} booking(s)`;
        data.forEach((b) => {
          const tr = document.createElement("tr");

          const statusPill =
            b.status === "canceled"
              ? `<span class="pill canceled">canceled</span>`
              : b.status === "completed"
                ? `<span class="pill completed">completed</span>`
                : `<span class="pill booked">booked</span>`;

          const actions =
            b.status === "booked"
              ? `<button class="btnSmall btnComplete" data-id="${b.id}" data-action="complete">Complete</button>
                 <button class="btnSmall btnCancel" data-id="${b.id}" data-action="cancel">Cancel</button>`
              : `<span class="muted">—</span>`;

          tr.innerHTML = `
            <td class="nowrap">${esc(b.date)}</td>
            <td class="nowrap">${esc(slotMap[b.slot] || b.slot)}</td>
            <td>${esc(b.name)}</td>
            <td class="nowrap">${esc(b.phone)}</td>
            <td>${esc(b.email)}</td>
            <td>${esc(b.address)}</td>
            <td>${esc(b.notes)}</td>
            <td class="nowrap">${statusPill}</td>
            <td class="nowrap">${actions}</td>
          `;
          rowsEl.appendChild(tr);
        });

        // wire buttons
        rowsEl.querySelectorAll("button[data-action]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            const action = btn.getAttribute("data-action");

            if (action === "cancel" && !confirm("Cancel this booking?")) return;
            if (
              action === "complete" &&
              !confirm("Mark this booking as completed?")
            )
              return;

            btn.disabled = true;
            btn.textContent =
              action === "cancel" ? "Canceling..." : "Completing...";

            const endpoint =
              action === "cancel" ? "/admin/cancel" : "/admin/complete";

            const res = await fetch(endpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id: Number(id) }),
            });

            if (!res.ok) {
              alert("Action failed.");
              btn.disabled = false;
              btn.textContent = action === "cancel" ? "Cancel" : "Complete";
              return;
            }

            // reload current filter
            await load(dateEl.value || "");
          });
        });
      }

      document
        .getElementById("load")
        .addEventListener("click", () => load(dateEl.value));
      document.getElementById("loadAll").addEventListener("click", () => {
        dateEl.value = "";
        load("");
      });
      document
        .getElementById("refresh")
        .addEventListener("click", () => load(dateEl.value || ""));

      // Auto-load today (if supported)
      (function init() {
        const t = new Date();
        dateEl.value = "";
        load("");
      })();
    </script>
  </body>
</html>
