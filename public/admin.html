<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin — All Keys Trailer Repair</title>
    <style>
      body {
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        background: #0b1220;
        color: #e5e7eb;
        padding: 18px;
      }
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
      }
      .card {
        background: #111827;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 14px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
        margin-bottom: 12px;
      }
      h1 {
        margin: 0 0 10px;
        font-size: 20px;
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      input {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: #0b1220;
        color: #e5e7eb;
      }
      button {
        padding: 10px 12px;
        border-radius: 12px;
        border: 0;
        background: #22c55e;
        color: #052e16;
        font-weight: 800;
        cursor: pointer;
      }
      button.secondary {
        background: #334155;
        color: #e5e7eb;
      }
      button.danger {
        background: #ef4444;
        color: #450a0a;
      }
      button:disabled {
        opacity: 0.65;
        cursor: not-allowed;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th,
      td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding: 10px 8px;
        vertical-align: top;
      }
      th {
        text-align: left;
        color: #93c5fd;
        font-size: 12px;
        letter-spacing: 0.04em;
      }

      .pill {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-weight: 800;
        font-size: 12px;
      }
      .booked {
        background: #1f2937;
        color: #e5e7eb;
      }
      .canceled {
        background: #7f1d1d;
        color: #fee2e2;
      }
      .completed {
        background: #14532d;
        color: #dcfce7;
      }

      .muted {
        color: #9ca3af;
      }
      .nowrap {
        white-space: nowrap;
      }
      .actions {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>Admin — Bookings</h1>
        <div class="row">
          <label class="muted">Filter by date (optional):</label>
          <input id="date" type="date" />
          <button id="load">Load</button>
          <button class="secondary" id="loadUpcoming">Load upcoming</button>
          <span class="muted" id="status"></span>
        </div>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th class="nowrap">Date</th>
              <th class="nowrap">Slot</th>
              <th>Name</th>
              <th class="nowrap">Phone</th>
              <th>Email</th>
              <th>Address</th>
              <th>Notes</th>
              <th class="nowrap">Status</th>
              <th class="nowrap">Action</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>

    <script>
      const rowsEl = document.getElementById("rows");
      const statusEl = document.getElementById("status");
      const dateEl = document.getElementById("date");

      function esc(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");
      }

      function ymdToday() {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
      }

      function statusPill(status) {
        if (status === "canceled")
          return `<span class="pill canceled">canceled</span>`;
        if (status === "completed")
          return `<span class="pill completed">completed</span>`;
        return `<span class="pill booked">booked</span>`;
      }

      async function apiPost(url, body) {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        return res;
      }

      async function load({ date = "", upcoming = false } = {}) {
        statusEl.textContent = "Loading...";
        rowsEl.innerHTML = "";

        let url = "/admin/bookings";
        if (date) {
          url = `/admin/bookings?date=${encodeURIComponent(date)}`;
        } else if (upcoming) {
          // If your server already filters upcoming, it will just work.
          // If not, we still filter client-side below.
          url = "/admin/bookings";
        }

        const res = await fetch(url);
        const data = await res.json();

        if (!Array.isArray(data)) {
          statusEl.textContent = "Error loading bookings.";
          return;
        }

        // Client-side "upcoming" filter (safe even if server doesn't do it)
        let rows = data;
        if (upcoming && !date) {
          const today = ymdToday();
          rows = rows
            .filter((b) => (b.status || "booked") === "booked")
            .filter((b) => String(b.date || "") >= today);
        }

        statusEl.textContent = `${rows.length} booking(s)`;

        rows.forEach((b) => {
          const tr = document.createElement("tr");
          const st = (b.status || "booked").toLowerCase();

          let actionHtml = `<span class="muted">—</span>`;
          if (st === "booked") {
            actionHtml = `
              <div class="actions">
                <button class="completeBtn" data-id="${b.id}">Complete</button>
                <button class="danger cancelBtn" data-id="${b.id}">Cancel</button>
              </div>
            `;
          }

          tr.innerHTML = `
            <td class="nowrap">${esc(b.date)}</td>
            <td class="nowrap">${esc(b.slot)}</td>
            <td>${esc(b.name)}</td>
            <td class="nowrap">${esc(b.phone)}</td>
            <td>${esc(b.email)}</td>
            <td>${esc(b.address)}</td>
            <td>${esc(b.notes)}</td>
            <td class="nowrap">${statusPill(st)}</td>
            <td class="nowrap">${actionHtml}</td>
          `;
          rowsEl.appendChild(tr);
        });

        // Wire up Complete
        rowsEl.querySelectorAll("button.completeBtn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = Number(btn.getAttribute("data-id"));
            if (!confirm("Mark this booking as COMPLETED?")) return;

            btn.disabled = true;
            btn.textContent = "Saving...";

            const res = await apiPost("/admin/complete", { id });
            if (!res.ok) {
              alert("Complete failed.");
              btn.disabled = false;
              btn.textContent = "Complete";
              return;
            }

            await load({ date: dateEl.value || "", upcoming: !dateEl.value });
          });
        });

        // Wire up Cancel
        rowsEl.querySelectorAll("button.cancelBtn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = Number(btn.getAttribute("data-id"));
            if (!confirm("Cancel this booking?")) return;

            btn.disabled = true;
            btn.textContent = "Canceling...";

            const res = await apiPost("/admin/cancel", { id });
            if (!res.ok) {
              alert("Cancel failed.");
              btn.disabled = false;
              btn.textContent = "Cancel";
              return;
            }

            await load({ date: dateEl.value || "", upcoming: !dateEl.value });
          });
        });
      }

      document
        .getElementById("load")
        .addEventListener("click", () =>
          load({ date: dateEl.value || "", upcoming: false }),
        );

      document.getElementById("loadUpcoming").addEventListener("click", () => {
        dateEl.value = "";
        load({ date: "", upcoming: true });
      });

      // default: upcoming
      load({ upcoming: true });
    </script>
  </body>
</html>
